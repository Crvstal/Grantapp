<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grant App - Exam Preparation Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-luxury: 'Playfair Display', Georgia, serif;
            --font-mono: 'SF Mono', 'Monaco', monospace;
            
            --primary: #1a365d;
            --secondary: #FFFFFF;
            --accent: #3182CE;
            --success: #059669;
            --warning: #D97706;
            --error: #DC2626;
            --info: #2563EB;
            
            --neutral-50: #FAFAFA;
            --neutral-100: #F5F5F5;
            --neutral-200: #E5E5E5;
            --neutral-300: #D4D4D4;
            --neutral-500: #737373;
            --neutral-700: #404040;
            --neutral-900: #171717;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --blur: blur(8px);
            --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --radius: 0.375rem;
            --border: 1px solid var(--neutral-200);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-primary); 
            color: var(--primary); 
            background: var(--secondary);
            line-height: 1.6;
        }

        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }

        .font-luxury { font-family: var(--font-luxury); }
        .font-mono { font-family: var(--font-mono); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }
        .grid { display: grid; gap: var(--space-lg); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-xs { gap: var(--space-xs); }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }

        .p-xs { padding: var(--space-xs); }
        .p-sm { padding: var(--space-sm); }
        .p-md { padding: var(--space-md); }
        .p-lg { padding: var(--space-lg); }
        .p-xl { padding: var(--space-xl); }
        .py-md { padding-top: var(--space-md); padding-bottom: var(--space-md); }
        .py-lg { padding-top: var(--space-lg); padding-bottom: var(--space-lg); }
        .py-xl { padding-top: var(--space-xl); padding-bottom: var(--space-xl); }
        .mb-md { margin-bottom: var(--space-md); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .mb-xl { margin-bottom: var(--space-xl); }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            border: var(--border);
            background: transparent;
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            cursor: pointer;
            transition: all var(--transition);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }

        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary { background: var(--primary); color: var(--secondary); border-color: var(--primary); }
        .btn-accent { background: var(--accent); color: var(--secondary); border-color: var(--accent); }
        .btn-success { background: var(--success); color: var(--secondary); border-color: var(--success); }
        .btn-error { background: var(--error); color: var(--secondary); border-color: var(--error); }
        .btn-ghost { border: none; background: none; }
        .btn-ghost:hover { background: var(--neutral-100); }

        .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: 0.75rem; }
        .btn-lg { padding: var(--space-md) var(--space-xl); font-size: 1rem; }

        .btn-loading {
            color: transparent !important;
            pointer-events: none;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 16px; height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .card {
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: all var(--transition);
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .card-header { padding: var(--space-lg); border-bottom: var(--border); }
        .card-body { padding: var(--space-lg); }
        .card-footer { padding: var(--space-lg); border-top: var(--border); }

        .form-group { margin-bottom: var(--space-lg); }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: var(--space-sm);
        }
        .form-input, .form-select {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: var(--border);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            background: var(--secondary);
            transition: all var(--transition);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: var(--blur);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(20px);
            transition: all var(--transition);
        }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }

        .modal-sm { width: 400px; }
        .modal-md { width: 600px; }
        .modal-lg { width: 800px; }

        .notification-container {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-width: 400px;
        }

        .notification {
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: var(--space-md);
            transform: translateX(100%);
            transition: all var(--transition);
            position: relative;
            border-left: 4px solid var(--neutral-200);
        }
        .notification.show { transform: translateX(0); }

        .notification-success { border-left-color: var(--success); }
        .notification-error { border-left-color: var(--error); }
        .notification-warning { border-left-color: var(--warning); }
        .notification-info { border-left-color: var(--info); }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-xs);
        }
        .notification-title { font-weight: 600; font-size: 0.875rem; }
        .notification-message { font-size: 0.875rem; color: var(--neutral-500); }
        .notification-close {
            background: none;
            border: none;
            color: var(--neutral-500);
            cursor: pointer;
            font-size: 1.125rem;
            padding: 0;
            line-height: 1;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--blur);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }
        .loading-overlay.active { opacity: 1; visibility: visible; }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--neutral-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            background: var(--secondary);
            border-bottom: var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .navbar-brand {
            font-family: var(--font-luxury);
            font-size: 1.25rem;
            text-decoration: none;
            color: var(--primary);
            letter-spacing: 0.05em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width var(--transition);
            border-radius: var(--radius);
        }

        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: var(--border);
        }

        .question-number {
            font-size: 0.875rem;
            color: var(--neutral-500);
            font-weight: 600;
        }

        .question-timer {
            font-size: 0.875rem;
            color: var(--warning);
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .question-text {
            font-size: 1.125rem;
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .options-list {
            list-style: none;
            margin-bottom: var(--space-xl);
        }

        .option-item {
            margin-bottom: var(--space-md);
        }

        .option-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            border: var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition);
            background: var(--secondary);
        }

        .option-label:hover {
            background: var(--neutral-50);
            border-color: var(--primary);
        }

        .option-label.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--neutral-300);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .option-label.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-label.selected .option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
            margin: var(--space-xl) 0;
        }

        .pagination-item {
            padding: var(--space-sm) var(--space-md);
            border: var(--border);
            background: var(--secondary);
            color: var(--primary);
            text-decoration: none;
            transition: all var(--transition);
            min-width: 40px;
            text-align: center;
            cursor: pointer;
            border-radius: var(--radius);
        }

        .pagination-item:hover {
            background: var(--neutral-100);
        }

        .pagination-item.active {
            background: var(--primary);
            color: var(--secondary);
        }

        .pagination-item:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .hidden { display: none; }
        .w-full { width: 100%; }
        .text-muted { color: var(--neutral-500); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .container { padding: 0 var(--space-sm); }
            .question-card { padding: var(--space-lg); }
            .quiz-controls { flex-direction: column; gap: var(--space-md); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="#" class="navbar-brand" onclick="goHome()">Grant App</a>
        <div class="flex items-center gap-md">
            <button class="btn btn-ghost" onclick="showComingSoon('Analytics')">Analytics</button>
            <button class="btn btn-ghost" onclick="showComingSoon('Rankings')">Rankings</button>
            <button class="btn btn-ghost" onclick="showComingSoon('Profile')">Profile</button>
        </div>
    </nav>

    <div class="container">
        <div id="home-screen" class="screen">
            <section class="py-2xl text-center mb-xl">
                <h1 class="font-luxury text-4xl mb-lg">Grant App</h1>
                <p class="text-lg text-muted mb-xl">Master your exams with our proprietary 5×2 taxonomy framework</p>
                
                <div class="grid grid-4 mb-xl">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">JAMB/UTME</h3>
                            <p class="text-muted mb-lg">Mathematics, English, Physics, Chemistry</p>
                            <button class="btn btn-primary w-full" onclick="selectExam('jamb')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">SAT Exams</h3>
                            <p class="text-muted mb-lg">Mathematics, English</p>
                            <button class="btn btn-primary w-full" onclick="selectExam('sat')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">AP Exams</h3>
                            <p class="text-muted mb-lg">Chemistry, Physics 1, Physics C</p>
                            <button class="btn btn-ghost w-full" onclick="showComingSoon('AP Exams')">Coming Soon</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">AWS Certs</h3>
                            <p class="text-muted mb-lg">Cloud Practitioner, Solutions Architect</p>
                            <button class="btn btn-ghost w-full" onclick="showComingSoon('AWS Certifications')">Coming Soon</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-header">
                        <h3 class="text-xl font-semibold">Quick Demo</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-lg">Experience our quiz system with sample Mathematics questions</p>
                        <button class="btn btn-accent btn-lg w-full" onclick="startDemo()">Try Demo Quiz</button>
                    </div>
                </div>
            </section>
        </div>

        <div id="subject-selection" class="screen hidden">
            <section class="py-xl">
                <div class="mb-xl">
                    <button class="btn btn-ghost" onclick="goBack()">&larr; Back</button>
                    <h2 class="text-3xl font-semibold text-center mb-lg" id="exam-title">Select Subject</h2>
                    <p class="text-center text-muted">Choose your subject to begin practice</p>
                </div>

                <div class="grid grid-2 mb-xl" id="subject-grid">
                </div>
            </section>
        </div>

        <div id="quiz-screen" class="screen hidden">
            <div class="quiz-container">
                <div class="card mb-lg">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-md">
                            <h2 class="text-xl font-semibold" id="quiz-title">Practice Mode</h2>
                            <button class="btn btn-ghost btn-sm" onclick="exitQuiz()">Exit Quiz</button>
                        </div>
                        <div class="progress-bar mb-md">
                            <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-muted">
                            <span id="progress-text">Question 1 of 20</span>
                            <span id="timer-display">Time: 30:00</span>
                        </div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number" id="question-number">Question 1</span>
                        <span class="question-timer" id="question-timer">00:30</span>
                    </div>
                    
                    <div class="question-text" id="question-text">
                        Loading question...
                    </div>
                    
                    <ul class="options-list" id="options-list">
                    </ul>
                    
                    <div class="quiz-controls">
                        <button class="btn btn-ghost" id="prev-btn" onclick="previousQuestion()" disabled>Previous</button>
                        <div class="flex gap-md">
                            <button class="btn btn-ghost" onclick="showComingSoon('Save & Continue Later')">Save & Continue</button>
                            <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next Question</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="font-semibold">Question Navigation</h4>
                    </div>
                    <div class="card-body">
                        <div class="pagination" id="question-nav">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen hidden">
            <section class="py-xl text-center">
                <h2 class="text-3xl font-semibold mb-lg">Quiz Complete!</h2>
                
                <div class="grid grid-3 mb-xl">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-accent mb-sm" id="score-display">0%</div>
                            <div class="text-muted">Overall Score</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-success mb-sm" id="correct-display">0</div>
                            <div class="text-muted">Correct Answers</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-3xl font-bold text-error mb-sm" id="incorrect-display">0</div>
                            <div class="text-muted">Incorrect Answers</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-xl" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-header">
                        <h3 class="text-xl font-semibold">Performance Analysis</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-lg">
                            <h4 class="font-semibold mb-sm">Taxonomy Breakdown</h4>
                            <div id="taxonomy-breakdown">
                            </div>
                        </div>
                        
                        <div class="flex gap-md">
                            <button class="btn btn-primary" onclick="reviewAnswers()">Review Answers</button>
                            <button class="btn btn-ghost" onclick="retakeQuiz()">Retake Quiz</button>
                            <button class="btn btn-ghost" onclick="showComingSoon('Detailed Analytics')">View Analytics</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="coming-soon-modal" class="modal-overlay">
        <div class="modal modal-sm">
            <div class="card-header">
                <h3 class="text-xl font-semibold">Coming Soon</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal('coming-soon-modal')">&times;</button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-lg" id="coming-soon-message">This feature is coming soon!</p>
                <p class="text-sm text-muted">We're working hard to bring you the best exam preparation experience. Stay tuned for updates!</p>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary w-full" onclick="closeModal('coming-soon-modal')">Got it</button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal-overlay">
        <div class="modal modal-sm">
            <div class="card-header">
                <h3 class="text-xl font-semibold text-error">Error</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal('error-modal')">&times;</button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-lg" id="error-message">An error occurred.</p>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary w-full" onclick="closeModal('error-modal')">OK</button>
            </div>
        </div>
    </div>

    <div class="notification-container" id="notifications"></div>

    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <script>
        const API_CONFIG = {
            BASE_URL: 'https://raw.githubusercontent.com/Crvstal/quizbank/main/',
            ENDPOINTS: {
                mathematics: 'jamb-mathematics.json',
                physics: 'jamb-physics-bank.tsx',
                chemistry: 'jamb-chemistry.json',
                english: 'jamb-english.json',
                sat_math: 'sat-mathematics.json',
                sat_english: 'sat-english.json'
            },
            CACHE_DURATION: 5 * 60 * 1000
        };

        const SOLANA_CONFIG = {
            MERCHANT_WALLET: 'GR8TuDpbnDvuLzW4JBCLjbeLvGFs1p21XBytLx6rA7XD',
            RPC_ENDPOINT: 'https://api.mainnet-beta.solana.com',
            NETWORK: 'mainnet-beta',
            
            PRICING: {
                premium_monthly: 9.99,
                premium_yearly: 99.99,
                professional_monthly: 19.99,
                professional_yearly: 199.99
            },

            USDC_MINT: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'
        };

        class TSXQuestionParser {
            static parseTSXContent(content) {
                try {
                    console.log('Starting TSX parsing...');
                    
                    const functionMatch = content.match(/const generatePhysicsQuestionBank = \(\) => \{([\s\S]*?)\n\};/);
                    if (!functionMatch) {
                        throw new Error('Could not find question generation function');
                    }

                    const topicsMatch = content.match(/const physicsTopics = \[([\s\S]*?)\];/);
                    const topics = topicsMatch ? this.parseArray(topicsMatch[1]) : [];

                    const templatesMatch = content.match(/const physicsQuestionTemplates = \[([\s\S]*?)\];/s);
                    const templates = templatesMatch ? this.parseTemplates(templatesMatch[1]) : [];

                    const questions = this.generateQuestionsFromTemplates(templates, topics);
                    
                    console.log(`Successfully parsed ${questions.length} questions from TSX`);
                    return questions;
                } catch (error) {
                    console.error('TSX parsing error:', error);
                    throw new Error(`Failed to parse TSX content: ${error.message}`);
                }
            }

            static parseArray(arrayContent) {
                return arrayContent
                    .split('\n')
                    .map(line => line.trim().replace(/['",]/g, '').trim())
                    .filter(line => line && !line.startsWith('//'))
                    .filter(Boolean);
            }

            static parseTemplates(templatesContent) {
                const templates = [];
                const templateRegex = /\{[\s\S]*?template: "([^"]+)",[\s\S]*?type: '([^']+)',[\s\S]*?info: '([^']+)',[\s\S]*?generator: \(\) => \{([\s\S]*?)\s*\}[^}]*\}/g;
                
                let match;
                while ((match = templateRegex.exec(templatesContent)) !== null) {
                    const [, template, type, info, generatorCode] = match;
                    
                    const generator = this.createSafeGenerator(generatorCode);
                    
                    if (generator) {
                        templates.push({
                            template,
                            type,
                            info,
                            generator
                        });
                    }
                }
                
                return templates;
            }

            static createSafeGenerator(generatorCode) {
                try {
                    const returnMatch = generatorCode.match(/return\s*\{([\s\S]*?)\}\s*;/);
                    if (!returnMatch) return null;

                    const returnContent = returnMatch[1];
                    
                    const questionMatch = returnContent.match(/question:\s*`([^`]*)`/);
                    const optionsMatch = returnContent.match(/options:\s*\[([^\]]*)\]/);
                    const correctMatch = returnContent.match(/correct:\s*(\d+)/);
                    const explanationMatch = returnContent.match(/explanation:\s*`([^`]*)`/);

                    if (!questionMatch || !optionsMatch || !correctMatch) return null;

                    const optionsText = optionsMatch[1];
                    const options = optionsText.split(',').map(opt => 
                        opt.trim().replace(/^`|`$/g, '').replace(/^"|"$/g, '')
                    );

                    return () => ({
                        question: questionMatch[1],
                        options: options,
                        correct: parseInt(correctMatch[1]),
                        explanation: explanationMatch ? explanationMatch[1] : 'No explanation available'
                    });
                } catch (error) {
                    console.error('Error creating generator:', error);
                    return null;
                }
            }

            static generateQuestionsFromTemplates(templates, topics) {
                const questions = [];
                const questionsPerTopic = Math.floor(300 / topics.length);
                
                topics.forEach((topic, topicIndex) => {
                    const extraQuestions = topicIndex < (300 % topics.length) ? 1 : 0;
                    const totalQuestions = questionsPerTopic + extraQuestions;
                    
                    for (let i = 0; i < totalQuestions; i++) {
                        const template = templates[i % templates.length];
                        if (template && template.generator) {
                            try {
                                const generated = template.generator();
                                questions.push({
                                    id: `jamb_phy_${(topicIndex * questionsPerTopic + i + 1).toString().padStart(3, '0')}`,
                                    subject: 'Physics',
                                    questionType: template.type,
                                    infoType: template.info,
                                    difficulty: ['Easy', 'Medium', 'Hard'][Math.floor(Math.random() * 3)],
                                    topic: topic,
                                    source: 'JAMB Physics Syllabus 2025',
                                    examType: 'JAMB/UTME',
                                    text: generated.question,
                                    options: generated.options,
                                    correct: generated.correct,
                                    explanation: generated.explanation,
                                    taxonomy: {
                                        type: template.type,
                                        info: template.info
                                    }
                                });
                            } catch (error) {
                                console.error('Error generating question:', error);
                            }
                        }
                    }
                });
                
                return questions;
            }
        }

        let questionCache = {};

        async function fetchQuestions(subject) {
            const cacheKey = `${subject}_questions`;
            const cacheTimestamp = `${subject}_timestamp`;
            
            const cachedQuestions = questionCache[cacheKey];
            const cacheTime = questionCache[cacheTimestamp];
            const now = Date.now();
            
            if (cachedQuestions && cacheTime && (now - cacheTime < API_CONFIG.CACHE_DURATION)) {
                console.log(`Using cached questions for ${subject}`);
                return cachedQuestions;
            }

            const endpoint = API_CONFIG.ENDPOINTS[subject];
            if (!endpoint) {
                console.error(`No endpoint configured for subject: ${subject}`);
                return getFallbackQuestions(subject);
            }

            const url = `${API_CONFIG.BASE_URL}${endpoint}`;
            
            try {
                console.log(`Fetching questions from: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': endpoint.endsWith('.tsx') ? 'text/plain' : 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                let data;
                
                if (endpoint.endsWith('.tsx')) {
                    const tsxContent = await response.text();
                    data = TSXQuestionParser.parseTSXContent(tsxContent);
                } else {
                    data = await response.json();
                }

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Invalid question data structure');
                }

                const validatedQuestions = data.filter(question => {
                    return question.id && 
                           (question.text || question.question) && 
                           Array.isArray(question.options) && 
                           question.options.length >= 4 &&
                           typeof question.correct === 'number';
                });

                if (validatedQuestions.length === 0) {
                    throw new Error('No valid questions found in response');
                }

                const normalizedQuestions = validatedQuestions.map(q => ({
                    id: q.id,
                    text: q.text || q.question,
                    options: q.options,
                    correct: q.correct,
                    explanation: q.explanation || 'No explanation available',
                    taxonomy: q.taxonomy || { type: 'unknown', info: 'unknown' },
                    subject: q.subject || subject,
                    difficulty: q.difficulty || 'Medium',
                    topic: q.topic || 'General'
                }));

                questionCache[cacheKey] = normalizedQuestions;
                questionCache[cacheTimestamp] = now;
                
                console.log(`Successfully loaded ${normalizedQuestions.length} questions for ${subject}`);
                return normalizedQuestions;

            } catch (error) {
                console.error(`Error fetching questions for ${subject}:`, error);
                GrantApp.showNotification('warning', 'Using Offline Mode', `Could not load latest questions. Using cached content.`);
                
                return cachedQuestions || getFallbackQuestions(subject);
            }
        }

        function getFallbackQuestions(subject) {
            const mathQuestions = [
                {
                    id: 'fallback_1',
                    text: "If 3x - 2 = 10, find the value of x.",
                    options: ["A) 3", "B) 4", "C) 5", "D) 6"],
                    correct: 1,
                    taxonomy: { type: "mathematical", info: "essential" },
                    explanation: "3x - 2 = 10\n3x = 10 + 2\n3x = 12\nx = 4"
                },
                {
                    id: 'fallback_2',
                    text: "What is the area of a circle with radius 7cm? (Take π = 22/7)",
                    options: ["A) 154 cm²", "B) 44 cm²", "C) 22 cm²", "D) 308 cm²"],
                    correct: 0,
                    taxonomy: { type: "pragmatic", info: "applied" },
                    explanation: "Area = πr² = (22/7) × 7² = (22/7) × 49 = 154 cm²"
                }
            ];

            const physicsQuestions = [
                {
                    id: 'physics_fallback_1',
                    text: "A car accelerates from 15 m/s at 3 m/s² for 5 seconds. Find the final velocity.",
                    options: ["A) 30 m/s", "B) 25 m/s", "C) 20 m/s", "D) 35 m/s"],
                    correct: 0,
                    taxonomy: { type: "mathematical", info: "essential" },
                    explanation: "Using v = u + at: v = 15 + 3 × 5 = 30 m/s"
                },
                {
                    id: 'physics_fallback_2',
                    text: "Convert 25°C to Kelvin.",
                    options: ["A) 298 K", "B) 273 K", "C) 250 K", "D) 300 K"],
                    correct: 0,
                    taxonomy: { type: "canon", info: "essential" },
                    explanation: "K = °C + 273 = 25 + 273 = 298 K"
                }
            ];

            if (subject.includes('physics')) return physicsQuestions;
            return mathQuestions;
        }

        function selectQuestionsByDifficulty(questions, difficulty = 'mixed', count = 20) {
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            
            if (difficulty === 'mixed') {
                return shuffled.slice(0, count);
            }
            
            const filtered = shuffled.filter(q => {
                const taxonomyComplexity = getTaxonomyComplexity(q.taxonomy);
                return taxonomyComplexity === difficulty;
            });
            
            return filtered.slice(0, Math.min(count, filtered.length));
        }

        function generateSolanaPayURL(amount, tier, reference) {
            const params = new URLSearchParams({
                recipient: SOLANA_CONFIG.MERCHANT_WALLET,
                amount: amount.toString(),
                'spl-token': SOLANA_CONFIG.USDC_MINT,
                reference: reference,
                label: 'Grant App',
                message: `${tier} subscription payment`,
                memo: `GrantApp_${tier}_${Date.now()}`
            });

            return `solana:${SOLANA_CONFIG.MERCHANT_WALLET}?${params.toString()}`;
        }

        function createSolanaPayQR(paymentUrl) {
            const qrData = encodeURIComponent(paymentUrl);
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${qrData}`;
        }

        async function initiateSolanaPayment(tier) {
            const amount = SOLANA_CONFIG.PRICING[tier];
            const reference = generatePaymentReference();
            const paymentUrl = generateSolanaPayURL(amount, tier, reference);
            const qrCodeUrl = createSolanaPayQR(paymentUrl);

            const paymentDetails = {
                reference,
                amount,
                tier,
                timestamp: Date.now(),
                status: 'pending'
            };

            sessionStorage.setItem(`payment_${reference}`, JSON.stringify(paymentDetails));

            return {
                paymentUrl,
                qrCodeUrl,
                reference,
                amount
            };
        }

        function generatePaymentReference() {
            return 'GrantApp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function verifyPayment(reference) {
            try {
                const storedPayment = sessionStorage.getItem(`payment_${reference}`);
                if (!storedPayment) throw new Error('Payment not found');

                const paymentData = JSON.parse(storedPayment);
                
                await new Promise(resolve => setTimeout(resolve, 2000));

                const isVerified = Math.random() > 0.3;

                if (isVerified) {
                    paymentData.status = 'completed';
                    paymentData.confirmedAt = Date.now();
                    sessionStorage.setItem(`payment_${reference}`, JSON.stringify(paymentData));
                    return true;
                } else {
                    throw new Error('Payment verification failed');
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                return false;
            }
        }

        let currentScreen = 'home';
        let currentExam = '';
        let currentQuiz = {
            subject: '',
            questions: [],
            currentQuestionIndex: 0,
            answers: {},
            startTime: null,
            timeLimit: 30 * 60,
            timer: null
        };

        const GrantApp = {
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                currentScreen = screenId;
            },

            notificationId: 0,
            showNotification(type, title, message, duration = 5000) {
                const container = document.getElementById('notifications');
                const id = `notification-${++this.notificationId}`;
                
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.id = id;
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">${title}</div>
                        <button class="notification-close" onclick="GrantApp.closeNotification('${id}')">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                container.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => this.closeNotification(id), duration);
            },

            closeNotification(id) {
                const notification = document.getElementById(id);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            },

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            },

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            },

            showLoading() {
                document.getElementById('loading').classList.add('active');
            },

            hideLoading() {
                document.getElementById('loading').classList.remove('active');
            },

            showError(message) {
                document.getElementById('error-message').textContent = message;
                this.openModal('error-modal');
            },

            startTimer() {
                if (currentQuiz.timer) clearInterval(currentQuiz.timer);
                
                currentQuiz.startTime = Date.now();
                currentQuiz.timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - currentQuiz.startTime) / 1000);
                    const remaining = Math.max(0, currentQuiz.timeLimit - elapsed);
                    
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    
                    document.getElementById('timer-display').textContent = 
                        `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (remaining <= 0) {
                        this.endQuiz();
                    }
                }, 1000);
            },

            stopTimer() {
                if (currentQuiz.timer) {
                    clearInterval(currentQuiz.timer);
                    currentQuiz.timer = null;
                }
            },

            loadQuestion(index) {
                if (index < 0 || index >= currentQuiz.questions.length) return;
                
                const question = currentQuiz.questions[index];
                currentQuiz.currentQuestionIndex = index;

                document.getElementById('question-number').textContent = `Question ${index + 1}`;
                document.getElementById('question-text').textContent = question.text;

                const optionsList = document.getElementById('options-list');
                optionsList.innerHTML = '';

                question.options.forEach((option, optIndex) => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    
                    const label = document.createElement('label');
                    label.className = 'option-label';
                    if (currentQuiz.answers[question.id] === optIndex) {
                        label.classList.add('selected');
                    }
                    
                    label.innerHTML = `
                        <div class="option-radio"></div>
                        <div>${option}</div>
                    `;
                    
                    label.addEventListener('click', () => this.selectOption(question.id, optIndex));
                    li.appendChild(label);
                    optionsList.appendChild(li);
                });

                const progress = ((index + 1) / currentQuiz.questions.length) * 100;
                document.getElementById('quiz-progress').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = 
                    `Question ${index + 1} of ${currentQuiz.questions.length}`;

                document.getElementById('prev-btn').disabled = index === 0;
                const nextBtn = document.getElementById('next-btn');
                nextBtn.textContent = index === currentQuiz.questions.length - 1 ? 'Finish Quiz' : 'Next Question';

                this.updateQuestionNavigation();
            },

            selectOption(questionId, optionIndex) {
                currentQuiz.answers[questionId] = optionIndex;
                
                const labels = document.querySelectorAll('.option-label');
                labels.forEach((label, index) => {
                    if (index === optionIndex) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });

                this.updateQuestionNavigation();
            },

            updateQuestionNavigation() {
                const nav = document.getElementById('question-nav');
                nav.innerHTML = '';

                currentQuiz.questions.forEach((question, index) => {
                    const item = document.createElement('div');
                    item.className = 'pagination-item';
                    item.textContent = index + 1;
                    
                    if (index === currentQuiz.currentQuestionIndex) {
                        item.classList.add('active');
                    }
                    
                    if (currentQuiz.answers.hasOwnProperty(question.id)) {
                        item.style.background = 'var(--success)';
                        item.style.color = 'var(--secondary)';
                    }
                    
                    item.addEventListener('click', () => this.loadQuestion(index));
                    nav.appendChild(item);
                });
            },

            async startQuiz(subject, questionCount = 20) {
                this.showLoading();
                
                try {
                    const allQuestions = await fetchQuestions(subject);
                    const selectedQuestions = selectQuestionsByDifficulty(allQuestions, 'mixed', questionCount);
                    
                    if (selectedQuestions.length === 0) {
                        throw new Error('No questions available');
                    }

                    currentQuiz = {
                        subject: subject,
                        questions: selectedQuestions,
                        currentQuestionIndex: 0,
                        answers: {},
                        startTime: null,
                        timeLimit: 30 * 60,
                        timer: null,
                        submitted: false
                    };

                    this.hideLoading();
                    this.showScreen('quiz-screen');
                    
                    const examName = currentExam === 'jamb' ? 'JAMB' : 'SAT';
                    const subjectName = subject.includes('math') ? 'Mathematics' : 
                                       subject.includes('english') ? 'English' : 
                                       subject.includes('physics') ? 'Physics' : subject;
                    document.getElementById('quiz-title').textContent = `${examName} ${subjectName} - Practice Mode`;
                    
                    this.loadQuestion(0);
                    this.startTimer();
                    
                    const sourceType = API_CONFIG.ENDPOINTS[subject].endsWith('.tsx') ? 'TSX component' : 'JSON file';
                    this.showNotification('success', 'Quiz Loaded', `${selectedQuestions.length} questions loaded from ${sourceType}.`);
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('Failed to start quiz:', error);
                    this.showError(`Failed to load questions: ${error.message}. Please check your internet connection and try again.`);
                }
            },

            endQuiz(submitted = false) {
                this.stopTimer();
                currentQuiz.submitted = submitted;
                currentQuiz.endTime = Date.now();
                
                this.calculateResults();
                this.showScreen('results-screen');
                
                const message = submitted ? 'Quiz submitted successfully!' : 'Quiz completed!';
                this.showNotification('success', 'Quiz Complete', message);
            },

            submitQuiz() {
                const unanswered = this.getUnansweredQuestions();
                
                if (unanswered.length > 0) {
                    const confirmMsg = `You have ${unanswered.length} unanswered questions. Submit anyway?`;
                    if (!confirm(confirmMsg)) return;
                }

                const modal = this.createSubmissionModal();
                document.body.appendChild(modal);
            },

            closeUpgradeModal() {
                const modal = document.getElementById('upgrade-modal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            async initiateSolanaPayment(tier) {
                this.showLoading();
                
                try {
                    const paymentData = await initiateSolanaPayment(tier);
                    this.hideLoading();
                    this.showSolanaPaymentModal(paymentData);
                } catch (error) {
                    this.hideLoading();
                    this.showError(`Payment initialization failed: ${error.message}`);
                }
            },

            showSolanaPaymentModal(paymentData) {
                const modal = document.createElement('div');
                modal.id = 'solana-payment-modal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal modal-md">
                        <div class="card-header">
                            <h3 class="text-xl font-semibold">Solana Payment</h3>
                            <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeSolanaPayment()">&times;</button>
                        </div>
                        <div class="card-body text-center">
                            <div class="mb-lg">
                                <h4 class="font-semibold mb-sm">Payment Amount</h4>
                                <div class="text-3xl font-bold text-accent mb-sm">${paymentData.amount} USDC</div>
                                <div class="text-sm text-muted">Reference: ${paymentData.reference}</div>
                            </div>
                            
                            <div class="mb-lg">
                                <img src="${paymentData.qrCodeUrl}" alt="Solana Pay QR Code" style="max-width: 250px; margin: 0 auto; border: 1px solid var(--neutral-200); border-radius: var(--radius);">
                            </div>
                            
                            <div class="mb-lg">
                                <p class="text-sm text-muted mb-md">Scan with your Solana wallet or click the link below:</p>
                                <a href="${paymentData.paymentUrl}" class="btn btn-accent" target="_blank">
                                    Open Solana Wallet
                                </a>
                            </div>
                            
                            <div class="mb-lg">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="payment-progress" style="width: 0%"></div>
                                </div>
                                <div class="text-sm text-muted mt-sm" id="payment-status">Waiting for payment...</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="flex gap-md">
                                <button class="btn btn-ghost" onclick="GrantApp.closeSolanaPayment()">Cancel</button>
                                <button class="btn btn-primary" onclick="GrantApp.checkPaymentStatus('${paymentData.reference}')">
                                    Check Payment Status
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.closeUpgradeModal();
                document.body.appendChild(modal);
                
                this.startPaymentStatusCheck(paymentData.reference);
            },

            startPaymentStatusCheck(reference) {
                const interval = setInterval(async () => {
                    const verified = await verifyPayment(reference);
                    const progressBar = document.getElementById('payment-progress');
                    const statusText = document.getElementById('payment-status');
                    
                    if (verified) {
                        clearInterval(interval);
                        if (progressBar) progressBar.style.width = '100%';
                        if (statusText) statusText.textContent = 'Payment confirmed!';
                        
                        setTimeout(() => {
                            this.closeSolanaPayment();
                            this.handleSuccessfulPayment(reference);
                        }, 2000);
                    } else {
                        const currentWidth = parseInt(progressBar?.style.width) || 0;
                        if (progressBar && currentWidth < 90) {
                            progressBar.style.width = `${Math.min(currentWidth + 10, 90)}%`;
                        }
                    }
                }, 3000);
                
                setTimeout(() => {
                    clearInterval(interval);
                    const statusText = document.getElementById('payment-status');
                    if (statusText) statusText.textContent = 'Payment timeout. Please try again.';
                }, 5 * 60 * 1000);
            },

            async checkPaymentStatus(reference) {
                this.showLoading();
                const verified = await verifyPayment(reference);
                this.hideLoading();
                
                if (verified) {
                    this.closeSolanaPayment();
                    this.handleSuccessfulPayment(reference);
                } else {
                    this.showNotification('warning', 'Payment Pending', 'Payment not yet confirmed. Please wait or try again.');
                }
            },

            handleSuccessfulPayment(reference) {
                sessionStorage.setItem('premium_active', 'true');
                sessionStorage.setItem('payment_reference', reference);
                
                this.showNotification('success', 'Payment Successful!', 'Premium features activated. Enjoy your enhanced analytics!');
                
                this.confirmSubmission();
            },

            closeSolanaPayment() {
                const modal = document.getElementById('solana-payment-modal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            proceedWithFree() {
                this.closeUpgradeModal();
                this.confirmSubmission();
            },

            getElapsedTime() {
                if (!currentQuiz.startTime) return '0:00';
                const elapsed = Math.floor((Date.now() - currentQuiz.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },

            isPremiumActive() {
                return sessionStorage.getItem('premium_active') === 'true';
            },

            getUnansweredQuestions() {
                return currentQuiz.questions.filter(q => !currentQuiz.answers.hasOwnProperty(q.id));
            },

            createSubmissionModal() {
                const modal = document.createElement('div');
                modal.id = 'submission-modal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal modal-md">
                        <div class="card-header">
                            <h3 class="text-xl font-semibold">Submit Quiz</h3>
                            <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeModal('submission-modal')">&times;</button>
                        </div>
                        <div class="card-body">
                            <div class="mb-lg">
                                <h4 class="font-semibold mb-sm">Quiz Summary</h4>
                                <div class="grid grid-2 gap-md text-sm">
                                    <div>Answered: <strong>${Object.keys(currentQuiz.answers).length}/${currentQuiz.questions.length}</strong></div>
                                    <div>Time Used: <strong>${this.getElapsedTime()}</strong></div>
                                </div>
                            </div>
                            
                            <div class="mb-lg">
                                <h4 class="font-semibold mb-sm">Premium Features Available</h4>
                                <div class="card">
                                    <div class="card-body">
                                        <ul class="text-sm text-muted" style="list-style: disc; padding-left: 1rem;">
                                            <li>Detailed answer explanations</li>
                                            <li>Advanced performance analytics</li>
                                            <li>Taxonomy-based insights</li>
                                            <li>Progress tracking & streaks</li>
                                            <li>Mock exam simulations</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-muted mb-lg">Choose how to proceed with your quiz submission:</p>
                        </div>
                        <div class="card-footer">
                            <div class="flex gap-md">
                                <button class="btn btn-primary" onclick="GrantApp.confirmSubmission()">
                                    📊 Submit & Get Basic Results
                                </button>
                                <button class="btn btn-accent" onclick="GrantApp.showUpgradeModal()">
                                    ⭐ Upgrade for Full Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return modal;
            },

            confirmSubmission() {
                this.closeModal('submission-modal');
                const submissionModal = document.getElementById('submission-modal');
                if (submissionModal) submissionModal.remove();
                
                this.endQuiz(true);
            },

            showUpgradeModal() {
                this.closeModal('submission-modal');
                const submissionModal = document.getElementById('submission-modal');
                if (submissionModal) submissionModal.remove();
                
                this.createUpgradeModal();
            },

            createUpgradeModal() {
                const modal = document.createElement('div');
                modal.id = 'upgrade-modal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal modal-lg">
                        <div class="card-header">
                            <h3 class="text-xl font-semibold">Upgrade to Premium</h3>
                            <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeUpgradeModal()">&times;</button>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-2 gap-lg mb-lg">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="font-semibold">Premium Monthly</h4>
                                        <div class="text-2xl font-bold text-accent">$9.99/mo</div>
                                    </div>
                                    <div class="card-body">
                                        <ul class="text-sm mb-lg" style="list-style: disc; padding-left: 1rem;">
                                            <li>Full question access (600+ questions)</li>
                                            <li>All stake levels (Practice → Mock → High Stakes)</li>
                                            <li>Detailed corrections & explanations</li>
                                            <li>Advanced analytics & streak tracking</li>
                                            <li>WES CGPA converter</li>
                                        </ul>
                                        <button class="btn btn-accent w-full" onclick="GrantApp.initiateSolanaPayment('premium_monthly')">
                                            🚀 Pay with Solana
                                        </button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="font-semibold">Professional Monthly</h4>
                                        <div class="text-2xl font-bold text-accent">$19.99/mo</div>
                                    </div>
                                    <div class="card-body">
                                        <ul class="text-sm mb-lg" style="list-style: disc; padding-left: 1rem;">
                                            <li>Multi-exam preparation (JAMB + SAT + AP + AWS)</li>
                                            <li>Global rankings in high-stake exams</li>
                                            <li>Priority support</li>
                                            <li>Advanced ML insights</li>
                                            <li>Bulk institutional licenses</li>
                                        </ul>
                                        <button class="btn btn-accent w-full" onclick="GrantApp.initiateSolanaPayment('professional_monthly')">
                                            ⭐ Pay with Solana
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button class="btn btn-ghost" onclick="GrantApp.proceedWithFree()">Continue with Free Results</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            calculateResults() {
                let correct = 0;
                let total = currentQuiz.questions.length;
                let taxonomyStats = {};

                currentQuiz.questions.forEach(question => {
                    const userAnswer = currentQuiz.answers[question.id];
                    const isCorrect = userAnswer === question.correct;
                    
                    if (isCorrect) correct++;

                    const key = `${question.taxonomy.type}-${question.taxonomy.info}`;
                    if (!taxonomyStats[key]) {
                        taxonomyStats[key] = { correct: 0, total: 0 };
                    }
                    taxonomyStats[key].total++;
                    if (isCorrect) taxonomyStats[key].correct++;
                });

                const score = Math.round((correct / total) * 100);

                document.getElementById('score-display').textContent = `${score}%`;
                document.getElementById('correct-display').textContent = correct;
                document.getElementById('incorrect-display').textContent = total - correct;

                const breakdown = document.getElementById('taxonomy-breakdown');
                breakdown.innerHTML = '';
                
                Object.entries(taxonomyStats).forEach(([key, stats]) => {
                    const percentage = Math.round((stats.correct / stats.total) * 100);
                    const div = document.createElement('div');
                    div.className = 'mb-sm';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-xs">
                            <span class="text-sm font-medium">${key.replace('-', ' ').toUpperCase()}</span>
                            <span class="text-sm">${stats.correct}/${stats.total} (${percentage}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    breakdown.appendChild(div);
                });
            }
        };

        function goHome() {
            GrantApp.showScreen('home-screen');
            GrantApp.stopTimer();
        }

        function goBack() {
            if (currentScreen === 'subject-selection') {
                GrantApp.showScreen('home-screen');
            } else if (currentScreen === 'quiz-screen') {
                if (confirm('Are you sure you want to exit the quiz? Your progress will be lost.')) {
                    GrantApp.showScreen('subject-selection');
                    GrantApp.stopTimer();
                }
            }
        }

        function selectExam(exam) {
            currentExam = exam;
            GrantApp.showScreen('subject-selection');
            
            document.getElementById('exam-title').textContent = `Select ${exam.toUpperCase()} Subject`;
            
            const subjectGrid = document.getElementById('subject-grid');
            subjectGrid.innerHTML = '';
            
            let subjects = [];
            
            if (exam === 'jamb') {
                subjects = [
                    { id: 'mathematics', name: 'Mathematics', status: 'available', questions: '300+ Questions' },
                    { id: 'english', name: 'English', status: 'coming-soon', questions: 'Coming Soon' },
                    { id: 'physics', name: 'Physics', status: 'available', questions: '300+ Questions (TSX)' },
                    { id: 'chemistry', name: 'Chemistry', status: 'coming-soon', questions: 'Coming Soon' }
                ];
            } else if (exam === 'sat') {
                subjects = [
                    { id: 'sat_math', name: 'SAT Mathematics', status: 'available', questions: '250+ Questions' },
                    { id: 'sat_english', name: 'SAT English', status: 'available', questions: '200+ Questions' }
                ];
            }
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-body text-center">
                        <h3 class="text-xl font-semibold mb-sm">${subject.name}</h3>
                        <p class="text-muted mb-lg">${subject.questions} | 5×2 Taxonomy</p>
                        ${subject.status === 'available' ? 
                            `<button class="btn btn-primary w-full" onclick="selectSubject('${subject.id}')">Start Practice</button>` :
                            `<button class="btn btn-ghost w-full" onclick="showComingSoon('${subject.name}')">Coming Soon</button>`
                        }
                    </div>
                `;
                subjectGrid.appendChild(card);
            });
        }

        function selectSubject(subject) {
            GrantApp.startQuiz(subject, 20);
        }

        async function startDemo() {
            try {
                GrantApp.showLoading();
                const questions = await fetchQuestions('mathematics');
                const demoQuestions = questions.slice(0, 10);
                GrantApp.hideLoading();
                currentExam = 'jamb';
                GrantApp.startQuiz('mathematics', 10);
            } catch (error) {
                GrantApp.hideLoading();
                GrantApp.showError('Failed to load demo questions. Please try again.');
            }
        }

        function previousQuestion() {
            if (currentQuiz.currentQuestionIndex > 0) {
                GrantApp.loadQuestion(currentQuiz.currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            const isLast = currentQuiz.currentQuestionIndex === currentQuiz.questions.length - 1;
            
            if (isLast) {
                GrantApp.submitQuiz();
            } else {
                GrantApp.loadQuestion(currentQuiz.currentQuestionIndex + 1);
            }
        }

        function exitQuiz() {
            if (confirm('Are you sure you want to exit? Your progress will be lost.')) {
                GrantApp.showScreen('subject-selection');
                GrantApp.stopTimer();
                GrantApp.showNotification('info', 'Quiz Exited', 'You can start a new quiz anytime.');
            }
        }

        function reviewAnswers() {
            if (GrantApp.isPremiumActive()) {
                showComingSoon('Detailed Answer Review');
            } else {
                GrantApp.showNotification('info', 'Premium Feature', 'Upgrade to access detailed answer reviews.');
                setTimeout(() => GrantApp.createUpgradeModal(), 1000);
            }
        }

        function retakeQuiz() {
            if (confirm('Start a new quiz with different questions?')) {
                selectSubject(currentQuiz.subject);
            }
        }

        function getTaxonomyComplexity(taxonomy) {
            const complexityMap = {
                'essential': 'easy',
                'contextual': 'medium', 
                'abstract': 'hard',
                'applied': 'medium',
                'proofs': 'hard'
            };
            return complexityMap[taxonomy.info] || 'medium';
        }

        function showComingSoon(feature) {
            document.getElementById('coming-soon-message').textContent = 
                `${feature} is coming soon! We're working hard to bring you this feature.`;
            GrantApp.openModal('coming-soon-modal');
        }

        function closeModal(modalId) {
            GrantApp.closeModal(modalId);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        GrantApp.closeModal(this.id);
                    }
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal-overlay.active');
                    if (activeModal) {
                        GrantApp.closeModal(activeModal.id);
                    }
                }

                if (currentScreen === 'quiz-screen') {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        previousQuestion();
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        nextQuestion();
                    } else if (e.key >= '1' && e.key <= '4') {
                        e.preventDefault();
                        const optionIndex = parseInt(e.key) - 1;
                        const currentQuestion = currentQuiz.questions[currentQuiz.currentQuestionIndex];
                        if (optionIndex < currentQuestion.options.length) {
                            GrantApp.selectOption(currentQuestion.id, optionIndex);
                        }
                    }
                }
            });

            setTimeout(() => {
                GrantApp.showNotification('info', 'Welcome to Grant App', 'Your exam preparation journey starts here!');
            }, 1000);
        });
    </script>
</body>
</html>