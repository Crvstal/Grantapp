<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrantApp - Adaptive Quiz Engine</title>
    <style>
        :root {
            /* Design System Variables */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-luxury: 'Playfair Display', Georgia, serif;
            --font-mono: 'SF Mono', 'Monaco', monospace;
            
            --primary: #000000;
            --secondary: #FFFFFF;
            --accent: #D4AF37;
            --success: #059669;
            --warning: #D97706;
            --error: #DC2626;
            --info: #2563EB;
            
            --neutral-50: #FAFAFA;
            --neutral-100: #F5F5F5;
            --neutral-200: #E5E5E5;
            --neutral-300: #D4D4D4;
            --neutral-500: #737373;
            --neutral-700: #404040;
            --neutral-900: #171717;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --blur: blur(8px);
            --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --radius: 0.375rem;
            --border: 1px solid var(--neutral-200);
        }

        /* Base Styles */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-primary); 
            color: var(--primary); 
            background: var(--secondary);
            line-height: 1.6;
        }

        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }

        .font-luxury { font-family: var(--font-luxury); }
        .font-mono { font-family: var(--font-mono); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }
        .grid { display: grid; gap: var(--space-lg); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-xs { gap: var(--space-xs); }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }

        /* Spacing */
        .p-xs { padding: var(--space-xs); }
        .p-sm { padding: var(--space-sm); }
        .p-md { padding: var(--space-md); }
        .p-lg { padding: var(--space-lg); }
        .p-xl { padding: var(--space-xl); }
        .py-md { padding-top: var(--space-md); padding-bottom: var(--space-md); }
        .py-lg { padding-top: var(--space-lg); padding-bottom: var(--space-lg); }
        .py-xl { padding-top: var(--space-xl); padding-bottom: var(--space-xl); }
        .mb-md { margin-bottom: var(--space-md); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .mb-xl { margin-bottom: var(--space-xl); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            border: var(--border);
            background: transparent;
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            cursor: pointer;
            transition: all var(--transition);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }

        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary { background: var(--primary); color: var(--secondary); border-color: var(--primary); }
        .btn-accent { background: var(--accent); color: var(--primary); border-color: var(--accent); }
        .btn-success { background: var(--success); color: var(--secondary); border-color: var(--success); }
        .btn-error { background: var(--error); color: var(--secondary); border-color: var(--error); }
        .btn-ghost { border: none; background: none; }
        .btn-ghost:hover { background: var(--neutral-100); }

        .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: 0.75rem; }
        .btn-lg { padding: var(--space-md) var(--space-xl); font-size: 1rem; }

        /* Cards */
        .card {
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: all var(--transition);
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .card-header { padding: var(--space-lg); border-bottom: var(--border); }
        .card-body { padding: var(--space-lg); }
        .card-footer { padding: var(--space-lg); border-top: var(--border); }

        /* Navigation */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            background: var(--secondary);
            border-bottom: var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .navbar-brand {
            font-family: var(--font-luxury);
            font-size: 1.25rem;
            text-decoration: none;
            color: var(--primary);
            letter-spacing: 0.05em;
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md) 0;
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '›';
            color: var(--neutral-300);
        }

        .breadcrumb-link {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb-link:hover {
            text-decoration: underline;
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: var(--blur);
        }

        .modal {
            background: var(--secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-sm { max-width: 400px; }
        .modal-md { max-width: 600px; }
        .modal-lg { max-width: 800px; }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: var(--blur);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--neutral-200);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-md);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Error States */
        .error-container {
            background: #fee;
            border: 1px solid var(--error);
            color: var(--error);
            padding: var(--space-md);
            border-radius: var(--radius);
            margin: var(--space-md) 0;
        }

        .error-icon {
            width: 20px;
            height: 20px;
            fill: var(--error);
            margin-right: var(--space-sm);
        }

        /* Tooltip System */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            background: var(--primary);
            color: var(--secondary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition);
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--primary);
        }

        .tooltip-container:hover .tooltip {
            opacity: 1;
        }

        /* Premium Features */
        .premium-badge {
            background: linear-gradient(45deg, var(--accent), #f4c430);
            color: var(--primary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .premium-feature {
            opacity: 0.6;
            position: relative;
        }

        .premium-feature::after {
            content: '🔒';
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            font-size: 0.875rem;
        }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width var(--transition);
            border-radius: var(--radius);
        }

        /* Quiz Specific Styles */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: var(--border);
        }

        .question-number {
            font-size: 0.875rem;
            color: var(--neutral-500);
            font-weight: 600;
        }

        .question-timer {
            font-size: 0.875rem;
            color: var(--warning);
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .question-text {
            font-size: 1.125rem;
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .options-list {
            list-style: none;
            margin-bottom: var(--space-xl);
        }

        .option-item {
            margin-bottom: var(--space-md);
        }

        .option-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-md);
            border: var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition);
            background: var(--secondary);
        }

        .option-label:hover {
            background: var(--neutral-50);
            border-color: var(--primary);
        }

        .option-label.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--neutral-300);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .option-label.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-label.selected .option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin: var(--space-lg) 0;
        }

        .metric-card {
            text-align: center;
            padding: var(--space-lg);
            background: var(--secondary);
            border: var(--border);
            border-radius: var(--radius);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stake-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stake-practice { background: var(--success); color: var(--secondary); }
        .stake-mock { background: var(--warning); color: var(--secondary); }
        .stake-high { background: var(--error); color: var(--secondary); }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .hidden { display: none; }
        .w-full { width: 100%; }
        .text-muted { color: var(--neutral-500); }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .container { padding: 0 var(--space-sm); }
            .question-card { padding: var(--space-lg); }
            .quiz-controls { flex-direction: column; gap: var(--space-md); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="#" class="navbar-brand" onclick="GrantApp.goHome()">GrantApp</a>
        <div class="flex items-center gap-md">
            <div class="tooltip-container">
                <button class="btn btn-ghost premium-feature" onclick="GrantApp.redirectToPremium()">
                    Analytics
                </button>
                <div class="tooltip">Upgrade to Premium for detailed analytics</div>
            </div>
            <div class="tooltip-container">
                <button class="btn btn-ghost premium-feature" onclick="GrantApp.redirectToPremium()">
                    Rankings
                </button>
                <div class="tooltip">Upgrade to Premium for leaderboards</div>
            </div>
            <button class="btn btn-ghost" onclick="GrantApp.showComingSoon('Profile')">Profile</button>
            <button class="btn btn-accent" onclick="GrantApp.redirectToPremium()">Upgrade</button>
        </div>
    </nav>

    <!-- Breadcrumb Navigation -->
    <div class="container" id="breadcrumb-container">
        <nav class="breadcrumb" id="breadcrumb" style="display: none;">
            <!-- Breadcrumb items will be populated by JavaScript -->
        </nav>
    </div>

    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <section class="py-2xl text-center mb-xl">
                <h1 class="font-luxury text-4xl mb-lg">GrantApp</h1>
                <p class="text-lg text-muted mb-xl">Master your exams with our proprietary adaptive framework</p>
                
                <div class="grid grid-3 mb-xl">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">JAMB/UTME</h3>
                            <p class="text-muted mb-lg">Mathematics, English, Physics, Chemistry</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.selectExam('jamb')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">SAT</h3>
                            <p class="text-muted mb-lg">Math, English, Reading & Writing</p>
                            <button class="btn btn-ghost w-full" onclick="GrantApp.showComingSoon('SAT Exams')">Coming Soon</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-2xl font-semibold mb-sm">AWS Certs</h3>
                            <p class="text-muted mb-lg">Cloud Practitioner, Solutions Architect</p>
                            <button class="btn btn-ghost w-full" onclick="GrantApp.showComingSoon('AWS Certifications')">Coming Soon</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-header">
                        <h3 class="text-xl font-semibold">Quick Demo</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-lg">Experience our adaptive quiz system with sample questions</p>
                        <button class="btn btn-accent btn-lg w-full" onclick="GrantApp.startDemo()">Try Demo Quiz</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Subject Selection Screen -->
        <div id="subject-selection" class="screen hidden">
            <section class="py-xl">
                <div class="mb-xl">
                    <button class="btn btn-ghost" onclick="GrantApp.goBack()">&larr; Back</button>
                    <h2 class="text-3xl font-semibold text-center mb-lg">Select Subject</h2>
                    <p class="text-center text-muted">Choose your subject to begin practice</p>
                </div>

                <div class="grid grid-2 mb-xl">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">Mathematics</h3>
                            <p class="text-muted mb-lg">500+ Questions | Full Taxonomy</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.selectSubject('mathematics')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">English</h3>
                            <p class="text-muted mb-lg">400+ Questions | Full Taxonomy</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.selectSubject('english')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">Physics</h3>
                            <p class="text-muted mb-lg">300+ Questions | Full Taxonomy</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.selectSubject('physics')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">Chemistry</h3>
                            <p class="text-muted mb-lg">350+ Questions | Full Taxonomy</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.selectSubject('chemistry')">Start Practice</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Quiz Mode Selection Screen -->
        <div id="quiz-mode-selection" class="screen hidden">
            <section class="py-xl">
                <div class="mb-xl">
                    <button class="btn btn-ghost" onclick="GrantApp.goBack()">&larr; Back</button>
                    <h2 class="text-3xl font-semibold text-center mb-lg">Select Quiz Mode</h2>
                    <p class="text-center text-muted">Choose your preferred quiz experience</p>
                </div>

                <div class="grid grid-3 mb-xl">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">Practice Mode</h3>
                            <p class="text-muted mb-lg">Low-stakes practice with adaptive difficulty</p>
                            <button class="btn btn-primary w-full" onclick="GrantApp.startQuiz('practice')">Start Practice</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">Mock Exam</h3>
                            <p class="text-muted mb-lg">Timed exam simulation with performance tracking</p>
                            <button class="btn btn-accent w-full" onclick="GrantApp.startQuiz('mock')">Start Mock</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-xl font-semibold mb-sm">High Stakes</h3>
                            <p class="text-muted mb-lg">Advanced questions with detailed analytics</p>
                            <button class="btn btn-error w-full" onclick="GrantApp.startQuiz('high')">Start Challenge</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <div class="quiz-container">
                <!-- Quiz Header -->
                <div class="card mb-lg">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-md">
                            <h2 class="text-xl font-semibold" id="quiz-title">Adaptive Quiz</h2>
                            <div class="flex items-center gap-md">
                                <span class="stake-badge" id="stake-badge">Practice</span>
                                <button class="btn btn-ghost btn-sm" onclick="GrantApp.exitQuiz()">Exit Quiz</button>
                            </div>
                        </div>
                        <div class="progress-bar mb-md">
                            <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-muted">
                            <span id="progress-text">Question 1 of 20</span>
                            <span id="timer-display">Time: 30:00</span>
                        </div>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="question-card">
                    <div class="question-header">
                        <div>
                            <span class="question-number" id="question-number">Question 1</span>
                            <span class="premium-badge" id="question-taxonomy" style="margin-left: 10px;">Pragmatic</span>
                        </div>
                        <span class="question-timer" id="question-timer">00:30</span>
                    </div>
                    
                    <div class="question-text" id="question-text">
                        Loading question...
                    </div>
                    
                    <ul class="options-list" id="options-list">
                        <!-- Options will be populated by JavaScript -->
                    </ul>
                    
                    <div class="quiz-controls">
                        <button class="btn btn-ghost" id="prev-btn" onclick="GrantApp.previousQuestion()" disabled>Previous</button>
                        <div class="flex gap-md">
                            <button class="btn btn-ghost" onclick="GrantApp.saveProgress()">Save Progress</button>
                            <button class="btn btn-primary" id="next-btn" onclick="GrantApp.nextQuestion()">Next Question</button>
                        </div>
                    </div>
                </div>

                <!-- Adaptive Metrics -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="font-semibold">Adaptive Metrics & Taxonomy Analysis</h4>
                    </div>
                    <div class="card-body">
                        <div class="analytics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="current-score">0%</div>
                                <div>Current Score</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="difficulty-level">Medium</div>
                                <div>Difficulty Level</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="pattern-type">Pragmatic</div>
                                <div>Question Pattern</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="info-classification">Essential</div>
                                <div>Information Type</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen hidden">
            <section class="py-xl text-center">
                <h2 class="text-3xl font-semibold mb-lg">Quiz Complete!</h2>
                
                <div class="analytics-grid mb-xl">
                    <div class="metric-card">
                        <div class="metric-value" id="score-display">0%</div>
                        <div>Overall Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="correct-display">0</div>
                        <div>Correct Answers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="incorrect-display">0</div>
                        <div>Incorrect Answers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="time-display">0:00</div>
                        <div>Time Taken</div>
                    </div>
                </div>

                <div class="card mb-xl" style="max-width: 800px; margin: 0 auto;">
                    <div class="card-header">
                        <h3 class="text-xl font-semibold">Taxonomy Analysis & Performance Matrix</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-lg">
                            <h4 class="font-semibold mb-sm">Question Pattern Performance</h4>
                            <div id="pattern-breakdown">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="mb-lg">
                            <h4 class="font-semibold mb-sm">Information Classification Mastery</h4>
                            <div id="information-breakdown">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="flex gap-md justify-center">
                            <button class="btn btn-primary" onclick="GrantApp.reviewAnswers()">Review Answers</button>
                            <button class="btn btn-ghost" onclick="GrantApp.retakeQuiz()">Retake Quiz</button>
                            <button class="btn btn-ghost premium-feature" onclick="GrantApp.redirectToPremium()">Detailed Analytics</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="coming-soon-modal" class="modal-overlay hidden">
        <div class="modal modal-sm">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">Coming Soon</h3>
                        <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeModal('coming-soon-modal')">&times;</button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-lg" id="coming-soon-message">This feature is coming soon!</p>
                    <p class="text-sm text-muted">We're working hard to bring you the best quiz experience. Stay tuned for updates!</p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary w-full" onclick="GrantApp.closeModal('coming-soon-modal')">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal-overlay hidden">
        <div class="modal modal-md">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-error">Error Occurred</h3>
                        <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeModal('error-modal')">&times;</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="error-container">
                        <div class="flex items-start gap-sm">
                            <svg class="error-icon" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                            </svg>
                            <div>
                                <div class="font-semibold mb-sm" id="error-title">Something went wrong</div>
                                <p id="error-message">An unexpected error occurred.</p>
                                <div class="text-sm text-muted mt-sm" id="error-details" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-lg">
                        <h4 class="font-semibold mb-sm">What you can try:</h4>
                        <ul class="text-sm text-muted" style="list-style-position: inside;">
                            <li>Check your internet connection</li>
                            <li>Refresh the page and try again</li>
                            <li>Clear your browser cache</li>
                            <li>Try a different subject or quiz mode</li>
                        </ul>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="flex gap-sm">
                        <button class="btn btn-primary" onclick="GrantApp.retryLastAction()">Retry</button>
                        <button class="btn btn-ghost" onclick="GrantApp.closeModal('error-modal')">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="premium-modal" class="modal-overlay hidden">
        <div class="modal modal-lg">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">Upgrade to Premium</h3>
                        <button class="btn btn-ghost btn-sm" onclick="GrantApp.closeModal('premium-modal')">&times;</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-lg">
                        <div class="premium-badge" style="display: inline-block; font-size: 1rem; padding: var(--space-sm) var(--space-md);">
                            Premium Features
                        </div>
                    </div>
                    
                    <div class="grid grid-2 gap-lg mb-lg">
                        <div>
                            <h4 class="font-semibold mb-sm">📊 Advanced Analytics</h4>
                            <p class="text-sm text-muted">Detailed performance tracking, learning patterns, and improvement recommendations.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-sm">🏆 Global Rankings</h4>
                            <p class="text-sm text-muted">Compare your progress with thousands of other students worldwide.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-sm">📚 Unlimited Questions</h4>
                            <p class="text-sm text-muted">Access to our complete question database with expert explanations.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-sm">🎯 Custom Study Plans</h4>
                            <p class="text-sm text-muted">Personalized study schedules based on your strengths and weaknesses.</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-muted mb-lg">Start your premium experience today!</p>
                        <button class="btn btn-accent btn-lg" onclick="GrantApp.redirectToSolpay()">Upgrade Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loading">
        <div class="loading-spinner"></div>
        <div class="text-lg font-semibold" id="loading-text">Loading questions...</div>
        <div class="text-sm text-muted" id="loading-detail">Please wait while we prepare your quiz</div>
    </div>

    <script>
        // Enhanced API Configuration with robust error handling
        const API_CONFIG = {
            BASE_URL: window.location.origin + '/',
            FALLBACK_URL: 'https://raw.githubusercontent.com/yourusername/GrantApp/main/',
            ENDPOINTS: {
                physics: 'physics-questions.json',
                mathematics: 'mathematics-questions.json', 
                english: 'english-questions.json',
                chemistry: 'chemistry-questions.json'
            },
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutes
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 1000
        };

        // Question taxonomy constants
        const QUESTION_PATTERNS = {
            PRAGMATIC: 'pragmatic_application',
            LOGICAL: 'logical_reasoning', 
            CANON: 'canon_administrative',
            STATISTICAL: 'statistical_predictive',
            MATHEMATICAL: 'pure_mathematical'
        };

        const INFORMATION_TYPES = {
            ESSENTIAL: 'essential',
            CONTEXTUAL: 'contextual_historical', 
            ABSTRACT: 'abstract_visual',
            SUPPLY_CHAIN: 'supply_chain_product',
            MATH_PROOFS: 'maths_proofs_formulas'
        };

        // Global state management
        let questionCache = {};
        let lastFailedAction = null;

        // Enhanced Adaptive Quiz Engine with complete taxonomy implementation
        class AdaptiveQuizEngine {
            constructor() {
                this.questions = [];
                this.userProfile = this.initializeUserProfile();
                this.currentQuiz = null;
                this.confidenceThreshold = 0.7;
                this.taxonomyMatrix = this.initializeTaxonomyMatrix();
            }

            // Initialize comprehensive user profile
            initializeUserProfile() {
                const patternMastery = {};
                const informationMastery = {};
                
                // Initialize all question patterns
                Object.values(QUESTION_PATTERNS).forEach(pattern => {
                    patternMastery[pattern] = { attempts: 0, correct: 0, avg_time: 0, confidence: 0.5 };
                });

                // Initialize all information types  
                Object.values(INFORMATION_TYPES).forEach(type => {
                    informationMastery[type] = { attempts: 0, correct: 0, avg_time: 0, confidence: 0.5 };
                });

                return {
                    patternMastery,
                    informationMastery,
                    currentDifficultyLevel: 0.5,
                    learningVelocity: 0.1,
                    streakCount: 0,
                    lastPerformance: [],
                    skillLevel: 'intermediate',
                    totalQuestions: 0,
                    totalCorrect: 0,
                    taxonomyProgress: this.initializeTaxonomyProgress()
                };
            }

            // Initialize taxonomy progress matrix
            initializeTaxonomyProgress() {
                const matrix = {};
                Object.values(QUESTION_PATTERNS).forEach(pattern => {
                    matrix[pattern] = {};
                    Object.values(INFORMATION_TYPES).forEach(type => {
                        matrix[pattern][type] = { attempts: 0, correct: 0, mastery: 0 };
                    });
                });
                return matrix;
            }

            // Initialize taxonomy matrix for classification
            initializeTaxonomyMatrix() {
                return {
                    patterns: {
                        pragmatic: { keywords: ['apply', 'use', 'practical', 'real-world', 'example'], complexity: 0.3 },
                        logical: { keywords: ['analyze', 'reasoning', 'logic', 'deduce', 'infer'], complexity: 0.6 },
                        canon: { keywords: ['definition', 'according to', 'rule', 'law', 'principle'], complexity: 0.4 },
                        statistical: { keywords: ['probability', 'data', 'statistics', 'predict', 'trend'], complexity: 0.7 },
                        mathematical: { keywords: ['solve', 'calculate', 'compute', 'derive', 'prove'], complexity: 0.8 }
                    },
                    information: {
                        essential: { keywords: ['fundamental', 'basic', 'essential', 'key', 'important'], priority: 1 },
                        contextual: { keywords: ['context', 'background', 'historical', 'setting'], priority: 0.7 },
                        abstract: { keywords: ['concept', 'theory', 'abstract', 'idea', 'principle'], priority: 0.8 },
                        supply_chain: { keywords: ['process', 'procedure', 'method', 'step', 'workflow'], priority: 0.6 },
                        math_proofs: { keywords: ['proof', 'formula', 'equation', 'theorem', 'derivation'], priority: 0.9 }
                    }
                };
            }

            // Enhanced question loading with comprehensive error handling
            async loadQuestions(subject) {
                const cacheKey = `${subject}_questions`;
                const cacheTimestamp = `${subject}_timestamp`;
                
                // Check cache first
                if (this.checkCache(cacheKey, cacheTimestamp)) {
                    console.log(`Using cached questions for ${subject}`);
                    this.questions = questionCache[cacheKey];
                    return this.questions;
                }

                const endpoint = API_CONFIG.ENDPOINTS[subject];
                if (!endpoint) {
                    throw new Error(`Subject "${subject}" not supported. Available: ${Object.keys(API_CONFIG.ENDPOINTS).join(', ')}`);
                }

                // Try multiple URLs with retry logic
                const urls = [
                    `${API_CONFIG.BASE_URL}${endpoint}`,
                    `${API_CONFIG.FALLBACK_URL}${endpoint}`
                ];
                
                for (const url of urls) {
                    try {
                        const questions = await this.fetchQuestionsWithRetry(url);
                        this.questions = this.enhanceQuestions(questions, subject);
                        
                        // Cache successful results
                        questionCache[cacheKey] = this.questions;
                        questionCache[cacheTimestamp] = Date.now();
                        
                        console.log(`Successfully loaded ${this.questions.length} questions for ${subject}`);
                        return this.questions;
                        
                    } catch (error) {
                        console.error(`Failed to load from ${url}:`, error.message);
                        continue;
                    }
                }
                
                throw new Error(`Failed to load ${subject} questions from all sources. Please check your connection and try again.`);
            }

            // Check cache validity
            checkCache(cacheKey, cacheTimestamp) {
                const cachedQuestions = questionCache[cacheKey];
                const cacheTime = questionCache[cacheTimestamp];
                const now = Date.now();
                
                return cachedQuestions && cacheTime && (now - cacheTime < API_CONFIG.CACHE_DURATION);
            }

            // Fetch questions with retry mechanism
            async fetchQuestionsWithRetry(url, attempt = 1) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return this.validateAndExtractQuestions(data, url);
                    
                } catch (error) {
                    if (attempt < API_CONFIG.RETRY_ATTEMPTS) {
                        console.log(`Retry attempt ${attempt + 1} for ${url}`);
                        await this.delay(API_CONFIG.RETRY_DELAY);
                        return this.fetchQuestionsWithRetry(url, attempt + 1);
                    }
                    throw error;
                }
            }

            // Validate and extract questions from various JSON formats
            validateAndExtractQuestions(data, url) {
                let questionsArray = [];
                
                // Handle different JSON structures
                if (data.questions && Array.isArray(data.questions)) {
                    questionsArray = data.questions;
                } else if (Array.isArray(data)) {
                    questionsArray = data;
                } else if (data.quiz && Array.isArray(data.quiz)) {
                    questionsArray = data.quiz;
                } else {
                    throw new Error(`Invalid JSON structure from ${url}`);
                }

                if (questionsArray.length === 0) {
                    throw new Error(`No questions found in ${url}`);
                }

                // Validate question structure
                const validQuestions = questionsArray.filter(this.validateQuestion);
                
                if (validQuestions.length === 0) {
                    throw new Error(`No valid questions in ${url}`);
                }

                return validQuestions;
            }

            // Validate individual question structure
            validateQuestion(question) {
                const hasText = question.question || question.text || question.prompt;
                const hasOptions = question.options || question.choices || question.answers;
                const validOptions = Array.isArray(hasOptions) && hasOptions.length >= 2;
                
                return hasText && validOptions;
            }

            // Enhanced question enhancement with full taxonomy implementation
            enhanceQuestions(questions, subject) {
                return questions.map((question, index) => {
                    const normalizedQ = this.normalizeQuestionStructure(question);
                    const cognitivePattern = this.classifyQuestionPattern(normalizedQ);
                    const informationType = this.classifyInformationType(normalizedQ);
                    const { shuffledOptions, correctIndex } = this.processOptions(normalizedQ);
                    
                    return {
                        id: normalizedQ.id || `${subject}_q_${index + 1}`,
                        text: normalizedQ.text,
                        options: shuffledOptions,
                        correct: correctIndex,
                        explanation: normalizedQ.explanation || 'Explanation not provided.',
                        topic: normalizedQ.topic || 'General',
                        difficulty: this.normalizeDifficulty(normalizedQ.difficulty),
                        subject: subject,
                        
                        // Taxonomy classifications
                        _cognitive: {
                            pattern: cognitivePattern,
                            complexity: this.taxonomyMatrix.patterns[cognitivePattern.split('_')[0]]?.complexity || 0.5
                        },
                        _information: {
                            type: informationType,
                            priority: this.taxonomyMatrix.information[informationType.split('_')[0]]?.priority || 0.5
                        },
                        _performance: {
                            avg_time: 45 + Math.random() * 30,
                            success_rate: 0.4 + Math.random() * 0.5,
                            skill_level: this.mapDifficultyToSkill(normalizedQ.difficulty)
                        },
                        _meta: {
                            prerequisites: this.extractPrerequisites(normalizedQ, subject),
                            teaches: this.extractLearningObjectives(normalizedQ, subject)
                        }
                    };
                });
            }

            // Classify question into cognitive pattern
            classifyQuestionPattern(question) {
                const text = question.text.toLowerCase();
                
                for (const [pattern, data] of Object.entries(this.taxonomyMatrix.patterns)) {
                    if (data.keywords.some(keyword => text.includes(keyword))) {
                        return QUESTION_PATTERNS[pattern.toUpperCase()] || QUESTION_PATTERNS.PRAGMATIC;
                    }
                }
                
                return QUESTION_PATTERNS.PRAGMATIC; // Default
            }

            // Classify information type
            classifyInformationType(question) {
                const text = question.text.toLowerCase();
                const topic = (question.topic || '').toLowerCase();
                
                for (const [type, data] of Object.entries(this.taxonomyMatrix.information)) {
                    if (data.keywords.some(keyword => text.includes(keyword) || topic.includes(keyword))) {
                        return INFORMATION_TYPES[type.toUpperCase()] || INFORMATION_TYPES.ESSENTIAL;
                    }
                }
                
                return INFORMATION_TYPES.ESSENTIAL; // Default
            }

            // Normalize question structure from different JSON formats
            normalizeQuestionStructure(question) {
                return {
                    id: question.id || question.questionId || question.qid,
                    text: question.question || question.text || question.prompt || question.stem,
                    options: question.options || question.choices || question.answers || [],
                    correctAnswer: question.correctAnswer || question.correct || question.answer,
                    explanation: question.explanation || question.rationale || question.solution_explanation,
                    topic: question.topic || question.subject || question.category,
                    difficulty: question.difficulty || question.level || 'medium'
                };
            }

            // Process and shuffle options
            processOptions(question) {
                let options = [...question.options];
                let correctIndex = 0;
                
                if (typeof question.correctAnswer === 'number') {
                    correctIndex = Math.max(0, Math.min(question.correctAnswer, options.length - 1));
                } else if (typeof question.correctAnswer === 'string') {
                    correctIndex = options.findIndex(opt => 
                        opt.toString().toLowerCase().trim() === question.correctAnswer.toLowerCase().trim()
                    );
                    if (correctIndex === -1) correctIndex = 0;
                }
                
                const correctAnswer = options[correctIndex];
                const shuffledOptions = this.shuffleArray(options);
                const newCorrectIndex = shuffledOptions.findIndex(opt => opt === correctAnswer);
                
                return {
                    shuffledOptions,
                    correctIndex: newCorrectIndex >= 0 ? newCorrectIndex : 0
                };
            }

            // Fisher-Yates shuffle
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Enhanced adaptive question selection
            selectNextQuestion(previousAnswer = null, responseTime = null) {
                if (previousAnswer !== null) {
                    this.updateUserProfile(previousAnswer, responseTime);
                }

                const candidateQuestions = this.filterAvailableQuestions();
                if (candidateQuestions.length === 0) {
                    return null; // No more questions
                }

                const scoredQuestions = this.scoreQuestions(candidateQuestions);
                return this.weightedSelection(scoredQuestions);
            }

            // Filter available questions
            filterAvailableQuestions() {
                const answeredIds = this.currentQuiz ? 
                    this.currentQuiz.answeredQuestions.map(q => q.question.id) : [];
                
                return this.questions.filter(q => !answeredIds.includes(q.id));
            }

            // Score questions for adaptive selection
            scoreQuestions(questions) {
                const weakPatterns = this.identifyWeakPatterns();
                const weakInformation = this.identifyWeakInformationTypes();
                
                return questions.map(q => {
                    let score = 1.0;
                    
                    // Prioritize weak areas
                    if (weakPatterns.includes(q._cognitive.pattern)) score += 2.0;
                    if (weakInformation.includes(q._information.type)) score += 1.5;
                    
                    // Difficulty matching
                    const complexityDiff = Math.abs(q._cognitive.complexity - this.userProfile.currentDifficultyLevel);
                    score += (1 - complexityDiff) * 1.5;
                    
                    // Variety bonus
                    const recentPatterns = this.userProfile.lastPerformance.slice(-3).map(p => p.pattern);
                    if (!recentPatterns.includes(q._cognitive.pattern)) score += 0.5;
                    
                    return { question: q, score };
                });
            }

            // Weighted random selection
            weightedSelection(scoredQuestions) {
                if (scoredQuestions.length === 0) return null;
                
                const totalScore = scoredQuestions.reduce((sum, item) => sum + item.score, 0);
                let random = Math.random() * totalScore;
                
                for (const item of scoredQuestions) {
                    random -= item.score;
                    if (random <= 0) return item.question;
                }
                
                return scoredQuestions[0].question;
            }

            // Check if user has premium
const premiumStatus = GrantAppPayments.getPremiumStatus();
if (premiumStatus.active) {
    // Enable premium features
    enablePremiumFeatures(premiumStatus.plan);
}

// Initiate payment from your app
GrantAppPayments.initiatePayment('pro_monthly', 15);

// Check transaction history
const transactions = GrantAppPayments.getTransactionHistory();

            // Update user profile with taxonomy tracking
            updateUserProfile(wasCorrect, responseTime) {
                const question = this.currentQuiz.currentQuestion;
                const pattern = question._cognitive.pattern;
                const infoType = question._information.type;
                
                // Update pattern mastery
                this.updateMastery(this.userProfile.patternMastery[pattern], wasCorrect, responseTime);
                
                // Update information type mastery
                this.updateMastery(this.userProfile.informationMastery[infoType], wasCorrect, responseTime);
                
                // Update taxonomy matrix
                const matrixCell = this.userProfile.taxonomyProgress[pattern][infoType];
                matrixCell.attempts++;
                if (wasCorrect) matrixCell.correct++;
                matrixCell.mastery = matrixCell.correct / matrixCell.attempts;
                
                // Update overall stats
                this.userProfile.totalQuestions++;
                if (wasCorrect) {
                    this.userProfile.totalCorrect++;
                    this.userProfile.streakCount++;
                } else {
                    this.userProfile.streakCount = 0;
                }
                
                // Store performance history
                this.userProfile.lastPerformance.push({
                    correct: wasCorrect,
                    pattern: pattern,
                    infoType: infoType,
                    time: responseTime,
                    complexity: question._cognitive.complexity
                });
                
                if (this.userProfile.lastPerformance.length > 10) {
                    this.userProfile.lastPerformance.shift();
                }
                
                // Adjust difficulty
                this.adjustDifficulty(wasCorrect, responseTime, question._cognitive.complexity);
            }

            // Update individual mastery tracking
            updateMastery(masteryObj, wasCorrect, responseTime) {
                masteryObj.attempts++;
                if (wasCorrect) masteryObj.correct++;
                masteryObj.avg_time = (masteryObj.avg_time * (masteryObj.attempts - 1) + responseTime) / masteryObj.attempts;
                masteryObj.confidence = masteryObj.correct / masteryObj.attempts;
            }

            // Identify weak patterns
            identifyWeakPatterns() {
                return Object.entries(this.userProfile.patternMastery)
                    .filter(([_, mastery]) => mastery.attempts > 0 && mastery.confidence < 0.6)
                    .map(([pattern, _]) => pattern);
            }

            // Identify weak information types
            identifyWeakInformationTypes() {
                return Object.entries(this.userProfile.informationMastery)
                    .filter(([_, mastery]) => mastery.attempts > 0 && mastery.confidence < 0.6)
                    .map(([type, _]) => type);
            }

            // Adaptive difficulty adjustment
            adjustDifficulty(wasCorrect, responseTime, questionComplexity) {
                const targetTime = 60;
                const velocity = this.userProfile.learningVelocity;
                
                if (wasCorrect) {
                    if (responseTime < targetTime * 0.7) {
                        this.userProfile.currentDifficultyLevel = Math.min(1.0, 
                            this.userProfile.currentDifficultyLevel + velocity * 1.5);
                    } else {
                        this.userProfile.currentDifficultyLevel = Math.min(1.0,
                            this.userProfile.currentDifficultyLevel + velocity * 0.5);
                    }
                } else {
                    this.userProfile.currentDifficultyLevel = Math.max(0.1,
                        this.userProfile.currentDifficultyLevel - velocity * 2);
                }
            }

            // Start quiz with proper initialization
            startQuiz(stakeLevel, questionCount = 20) {
                this.currentQuiz = {
                    stakeLevel,
                    type: 'adaptive',
                    questions: [],
                    answeredQuestions: [],
                    currentQuestion: null,
                    startTime: Date.now(),
                    questionStartTime: Date.now(),
                    questionCount,
                    currentQuestionIndex: 0
                };
                
                // Adjust learning parameters by stake level
                switch(stakeLevel) {
                    case 'practice':
                        this.userProfile.learningVelocity = 0.15;
                        break;
                    case 'mock':
                        this.userProfile.learningVelocity = 0.1;
                        break;
                    case 'high':
                        this.userProfile.learningVelocity = 0.05;
                        break;
                }
                
                return this.getNextQuestion();
            }

            // Get next question
            getNextQuestion() {
                if (!this.currentQuiz) return null;
                
                const question = this.selectNextQuestion();
                if (!question) return null;
                
                this.currentQuiz.currentQuestion = question;
                this.currentQuiz.questionStartTime = Date.now();
                this.currentQuiz.currentQuestionIndex++;
                
                return question;
            }

            // Answer current question
            answerQuestion(selectedOption) {
                if (!this.currentQuiz?.currentQuestion) return null;
                
                const question = this.currentQuiz.currentQuestion;
                const isCorrect = selectedOption === question.correct;
                const responseTime = (Date.now() - this.currentQuiz.questionStartTime) / 1000;
                
                const answerData = {
                    question,
                    selectedOption,
                    isCorrect,
                    responseTime,
                    timestamp: Date.now()
                };
                
                this.currentQuiz.answeredQuestions.push(answerData);
                this.updateUserProfile(isCorrect, responseTime);
                
                return answerData;
            }

            // Get quiz results
            getResults() {
                if (!this.currentQuiz) return null;
                
                const answered = this.currentQuiz.answeredQuestions;
                const correctCount = answered.filter(a => a.isCorrect).length;
                const totalTime = (Date.now() - this.currentQuiz.startTime) / 1000;
                
                return {
                    totalQuestions: answered.length,
                    correctCount,
                    score: (correctCount / answered.length) * 100,
                    totalTime,
                    averageTime: totalTime / answered.length,
                    streak: this.userProfile.streakCount,
                    performanceByPattern: this.calculatePatternPerformance(),
                    performanceByInformation: this.calculateInformationPerformance(),
                    userProfile: { ...this.userProfile },
                    quizDetails: {
                        stakeLevel: this.currentQuiz.stakeLevel,
                        type: this.currentQuiz.type,
                        startTime: this.currentQuiz.startTime
                    }
                };
            }

            // Calculate pattern performance breakdown
            calculatePatternPerformance() {
                const performance = {};
                Object.values(QUESTION_PATTERNS).forEach(pattern => {
                    const patternAnswers = this.currentQuiz.answeredQuestions
                        .filter(a => a.question._cognitive.pattern === pattern);
                    
                    if (patternAnswers.length > 0) {
                        const correct = patternAnswers.filter(a => a.isCorrect).length;
                        performance[pattern] = {
                            total: patternAnswers.length,
                            correct,
                            percentage: (correct / patternAnswers.length) * 100,
                            averageTime: patternAnswers.reduce((sum, a) => sum + a.responseTime, 0) / patternAnswers.length
                        };
                    }
                });
                return performance;
            }

            // Calculate information type performance
            calculateInformationPerformance() {
                const performance = {};
                Object.values(INFORMATION_TYPES).forEach(type => {
                    const typeAnswers = this.currentQuiz.answeredQuestions
                        .filter(a => a.question._information.type === type);
                    
                    if (typeAnswers.length > 0) {
                        const correct = typeAnswers.filter(a => a.isCorrect).length;
                        performance[type] = {
                            total: typeAnswers.length,
                            correct,
                            percentage: (correct / typeAnswers.length) * 100,
                            averageTime: typeAnswers.reduce((sum, a) => sum + a.responseTime, 0) / typeAnswers.length
                        };
                    }
                });
                return performance;
            }

            // Utility methods
            normalizeDifficulty(difficulty) {
                if (typeof difficulty === 'number') return Math.max(0, Math.min(1, difficulty));
                
                const levels = {
                    'easy': 0.3, 'beginner': 0.3, 'low': 0.3,
                    'medium': 0.5, 'intermediate': 0.5, 'moderate': 0.5,
                    'hard': 0.7, 'advanced': 0.7, 'high': 0.7,
                    'expert': 0.9, 'challenging': 0.9
                };
                
                return levels[difficulty?.toLowerCase()] || 0.5;
            }

            mapDifficultyToSkill(difficulty) {
                const level = this.normalizeDifficulty(difficulty);
                if (level < 0.4) return 'beginner';
                if (level < 0.6) return 'intermediate';
                if (level < 0.8) return 'advanced';
                return 'expert';
            }

            extractPrerequisites(question, subject) {
                // Simple keyword-based prerequisite extraction
                const text = question.text.toLowerCase();
                const prerequisites = [];
                
                if (text.includes('calculate') || text.includes('solve')) {
                    prerequisites.push('basic_arithmetic');
                }
                if (text.includes('equation') || text.includes('formula')) {
                    prerequisites.push('algebra_fundamentals');
                }
                if (text.includes('graph') || text.includes('plot')) {
                    prerequisites.push('graph_interpretation');
                }
                
                return prerequisites.length > 0 ? prerequisites : ['general_knowledge'];
            }

            extractLearningObjectives(question, subject) {
                // Extract potential learning objectives
                const objectives = [];
                const text = question.text.toLowerCase();
                
                if (text.includes('apply') || text.includes('use')) {
                    objectives.push('practical_application');
                }
                if (text.includes('analyze') || text.includes('interpret')) {
                    objectives.push('analytical_thinking');
                }
                if (text.includes('explain') || text.includes('describe')) {
                    objectives.push('conceptual_understanding');
                }
                
                return objectives.length > 0 ? objectives : ['knowledge_recall'];
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Main Application Controller
        const GrantApp = {
            quizEngine: new AdaptiveQuizEngine(),
            currentScreen: 'home-screen',
            navigationStack: [],
            currentSubject: null,
            currentStakeLevel: null,
            quizTimer: null,
            questionTimer: null,
            timeRemaining: 1800, // 30 minutes in seconds

            // Navigation and Screen Management
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                this.currentScreen = screenId;
                this.updateBreadcrumb();
            },

            goHome() {
                this.navigationStack = [];
                this.showScreen('home-screen');
                this.clearTimers();
            },

            goBack() {
                if (this.navigationStack.length > 0) {
                    const previousScreen = this.navigationStack.pop();
                    this.showScreen(previousScreen);
                } else {
                    this.goHome();
                }
            },

            navigateTo(screenId) {
                this.navigationStack.push(this.currentScreen);
                this.showScreen(screenId);
            },

            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                const container = document.getElementById('breadcrumb-container');
                
                if (this.currentScreen === 'home-screen') {
                    breadcrumb.style.display = 'none';
                    return;
                }
                
                breadcrumb.style.display = 'flex';
                breadcrumb.innerHTML = '';
                
                // Home breadcrumb
                this.addBreadcrumbItem(breadcrumb, 'Home', this.goHome.bind(this));
                
                // Subject selection
                if (this.currentScreen === 'subject-selection') {
                    this.addBreadcrumbItem(breadcrumb, 'JAMB/UTME', null, true);
                }
                
                // Quiz mode selection
                if (this.currentScreen === 'quiz-mode-selection') {
                    this.addBreadcrumbItem(breadcrumb, 'JAMB/UTME', null);
                    this.addBreadcrumbItem(breadcrumb, this.currentSubject, null, true);
                }
                
                // Quiz screen
                if (this.currentScreen === 'quiz-screen') {
                    this.addBreadcrumbItem(breadcrumb, 'JAMB/UTME', null);
                    this.addBreadcrumbItem(breadcrumb, this.currentSubject, null);
                    this.addBreadcrumbItem(breadcrumb, this.currentStakeLevel, null, true);
                }
                
                // Results screen
                if (this.currentScreen === 'results-screen') {
                    this.addBreadcrumbItem(breadcrumb, 'JAMB/UTME', null);
                    this.addBreadcrumbItem(breadcrumb, this.currentSubject, null);
                    this.addBreadcrumbItem(breadcrumb, this.currentStakeLevel, null);
                    this.addBreadcrumbItem(breadcrumb, 'Results', null, true);
                }
            },

            addBreadcrumbItem(container, text, onClick, isActive = false) {
                const item = document.createElement('div');
                item.className = 'breadcrumb-item';
                
                if (isActive) {
                    item.innerHTML = `<span class="text-muted">${text}</span>`;
                } else {
                    item.innerHTML = `<a class="breadcrumb-link" onclick="${onClick ? onClick.toString().replace('function', '').trim() : 'GrantApp.goHome()'}">${text}</a>`;
                }
                
                container.appendChild(item);
            },

            // Exam and Subject Selection
            selectExam(examType) {
                if (examType === 'jamb') {
                    this.currentSubject = null;
                    this.navigateTo('subject-selection');
                } else {
                    this.showComingSoon(`${examType.toUpperCase()} Exams`);
                }
            },

            selectSubject(subject) {
                this.currentSubject = subject;
                this.navigateTo('quiz-mode-selection');
            },

            // Quiz Management
            async startQuiz(stakeLevel) {
                this.currentStakeLevel = stakeLevel;
                this.showLoading('Loading questions...', 'Preparing your adaptive quiz experience');
                
                try {
                    await this.quizEngine.loadQuestions(this.currentSubject);
                    const firstQuestion = this.quizEngine.startQuiz(stakeLevel);
                    
                    if (!firstQuestion) {
                        throw new Error('No questions available for this subject');
                    }
                    
                    this.navigateTo('quiz-screen');
                    this.initializeQuizInterface();
                    this.displayQuestion(firstQuestion);
                    this.startTimers();
                    
                } catch (error) {
                    this.showError('Failed to start quiz', error.message, error);
                } finally {
                    this.hideLoading();
                }
            },

            startDemo() {
                this.currentSubject = 'mathematics';
                this.currentStakeLevel = 'practice';
                this.startQuiz('practice');
            },

            initializeQuizInterface() {
                // Set quiz title and stake badge
                document.getElementById('quiz-title').textContent = `${this.currentSubject} Quiz`;
                document.getElementById('stake-badge').textContent = this.currentStakeLevel;
                document.getElementById('stake-badge').className = `stake-badge stake-${this.currentStakeLevel}`;
                
                // Reset progress
                document.getElementById('quiz-progress').style.width = '0%';
                document.getElementById('progress-text').textContent = 'Question 1 of 20';
                this.timeRemaining = 1800; // Reset timer
                this.updateTimerDisplay();
            },

            displayQuestion(question) {
                if (!question) return;
                
                document.getElementById('question-text').textContent = question.text;
                document.getElementById('question-number').textContent = `Question ${this.quizEngine.currentQuiz.currentQuestionIndex}`;
                document.getElementById('question-taxonomy').textContent = 
                    question._cognitive.pattern.split('_')[0].charAt(0).toUpperCase() + 
                    question._cognitive.pattern.split('_')[0].slice(1);
                
                // Update progress
                const progress = (this.quizEngine.currentQuiz.currentQuestionIndex / this.quizEngine.currentQuiz.questionCount) * 100;
                document.getElementById('quiz-progress').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = 
                    `Question ${this.quizEngine.currentQuiz.currentQuestionIndex} of ${this.quizEngine.currentQuiz.questionCount}`;
                
                // Display options
                const optionsList = document.getElementById('options-list');
                optionsList.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    
                    li.innerHTML = `
                        <label class="option-label" onclick="GrantApp.selectOption(${index})">
                            <span class="option-radio"></span>
                            <span class="option-text">${option}</span>
                        </label>
                    `;
                    
                    optionsList.appendChild(li);
                });
                
                // Update navigation buttons
                document.getElementById('prev-btn').disabled = this.quizEngine.currentQuiz.currentQuestionIndex === 1;
                document.getElementById('next-btn').textContent = 
                    this.quizEngine.currentQuiz.currentQuestionIndex === this.quizEngine.currentQuiz.questionCount ? 
                    'Finish Quiz' : 'Next Question';
                
                // Update adaptive metrics
                this.updateAdaptiveMetrics();
            },

            selectOption(optionIndex) {
                // Remove previous selection
                document.querySelectorAll('.option-label').forEach(label => {
                    label.classList.remove('selected');
                });
                
                // Add selection to current option
                const labels = document.querySelectorAll('.option-label');
                if (labels[optionIndex]) {
                    labels[optionIndex].classList.add('selected');
                }
                
                // Enable next button
                document.getElementById('next-btn').disabled = false;
            },

            nextQuestion() {
                const selectedLabel = document.querySelector('.option-label.selected');
                if (!selectedLabel && this.quizEngine.currentQuiz.currentQuestionIndex < this.quizEngine.currentQuiz.questionCount) {
                    this.showError('Selection Required', 'Please select an answer before proceeding.');
                    return;
                }
                
                // Process current answer if available
                if (selectedLabel) {
                    const optionIndex = Array.from(document.querySelectorAll('.option-label')).indexOf(selectedLabel);
                    this.quizEngine.answerQuestion(optionIndex);
                }
                
                // Get next question or finish quiz
                if (this.quizEngine.currentQuiz.currentQuestionIndex >= this.quizEngine.currentQuiz.questionCount) {
                    this.finishQuiz();
                } else {
                    const nextQuestion = this.quizEngine.getNextQuestion();
                    if (nextQuestion) {
                        this.displayQuestion(nextQuestion);
                        this.resetQuestionTimer();
                    } else {
                        this.finishQuiz();
                    }
                }
            },

            previousQuestion() {
                // Navigate to previous question (simplified implementation)
                if (this.quizEngine.currentQuiz.currentQuestionIndex > 1) {
                    this.quizEngine.currentQuiz.currentQuestionIndex--;
                    // In a real implementation, you'd need to track question history
                    this.showError('Navigation Limited', 'Previous question navigation is limited in this demo.');
                }
            },

            finishQuiz() {
                this.clearTimers();
                const results = this.quizEngine.getResults();
                this.displayResults(results);
                this.navigateTo('results-screen');
            },

            displayResults(results) {
                document.getElementById('score-display').textContent = `${results.score.toFixed(1)}%`;
                document.getElementById('correct-display').textContent = results.correctCount;
                document.getElementById('incorrect-display').textContent = results.totalQuestions - results.correctCount;
                document.getElementById('time-display').textContent = this.formatTime(results.totalTime);
                
                // Display pattern breakdown
                const patternBreakdown = document.getElementById('pattern-breakdown');
                patternBreakdown.innerHTML = Object.entries(results.performanceByPattern)
                    .map(([pattern, data]) => `
                        <div class="flex justify-between mb-xs">
                            <span>${pattern.split('_')[0]}:</span>
                            <span>${data.percentage.toFixed(1)}% (${data.correct}/${data.total})</span>
                        </div>
                    `).join('');
                
                // Display information breakdown
                const informationBreakdown = document.getElementById('information-breakdown');
                informationBreakdown.innerHTML = Object.entries(results.performanceByInformation)
                    .map(([type, data]) => `
                        <div class="flex justify-between mb-xs">
                            <span>${type.split('_')[0]}:</span>
                            <span>${data.percentage.toFixed(1)}% (${data.correct}/${data.total})</span>
                        </div>
                    `).join('');
            },

            updateAdaptiveMetrics() {
                const profile = this.quizEngine.userProfile;
                document.getElementById('current-score').textContent = 
                    profile.totalQuestions > 0 ? `${((profile.totalCorrect / profile.totalQuestions) * 100).toFixed(1)}%` : '0%';
                
                document.getElementById('difficulty-level').textContent = 
                    profile.currentDifficultyLevel < 0.4 ? 'Easy' : 
                    profile.currentDifficultyLevel < 0.7 ? 'Medium' : 'Hard';
                
                const currentPattern = this.quizEngine.currentQuiz?.currentQuestion?._cognitive.pattern;
                if (currentPattern) {
                    document.getElementById('pattern-type').textContent = 
                        currentPattern.split('_')[0].charAt(0).toUpperCase() + currentPattern.split('_')[0].slice(1);
                }
                
                const currentInfo = this.quizEngine.currentQuiz?.currentQuestion?._information.type;
                if (currentInfo) {
                    document.getElementById('info-classification').textContent = 
                        currentInfo.split('_')[0].charAt(0).toUpperCase() + currentInfo.split('_')[0].slice(1);
                }
            },

            // Timer Management
            startTimers() {
                this.clearTimers();
                
                // Main quiz timer
                this.quizTimer = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timeRemaining <= 0) {
                        this.finishQuiz();
                    }
                }, 1000);
                
                // Question timer (reset for each question)
                this.resetQuestionTimer();
            },

            resetQuestionTimer() {
                if (this.questionTimer) clearInterval(this.questionTimer);
                
                let questionTime = 60; // 60 seconds per question
                const questionTimerEl = document.getElementById('question-timer');
                
                this.questionTimer = setInterval(() => {
                    questionTime--;
                    questionTimerEl.textContent = `00:${questionTime.toString().padStart(2, '0')}`;
                    
                    if (questionTime <= 0) {
                        clearInterval(this.questionTimer);
                        this.nextQuestion(); // Auto-advance when time expires
                    }
                }, 1000);
            },

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                document.getElementById('timer-display').textContent = 
                    `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },

            clearTimers() {
                if (this.quizTimer) clearInterval(this.quizTimer);
                if (this.questionTimer) clearInterval(this.questionTimer);
            },

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            },

            // Utility Methods
            exitQuiz() {
                if (confirm('Are you sure you want to exit the quiz? Your progress will be lost.')) {
                    this.clearTimers();
                    this.goHome();
                }
            },

            saveProgress() {
                this.showComingSoon('Progress Saving');
            },

            reviewAnswers() {
                this.showComingSoon('Answer Review');
            },

            retakeQuiz() {
                this.startQuiz(this.currentStakeLevel);
            },

            // Modal Management
            showComingSoon(featureName) {
                document.getElementById('coming-soon-message').textContent = 
                    `${featureName} is coming soon!`;
                this.showModal('coming-soon-modal');
            },

            showError(title, message, error = null) {
                document.getElementById('error-title').textContent = title;
                document.getElementById('error-message').textContent = message;
                
                if (error) {
                    document.getElementById('error-details').textContent = error.stack || error.toString();
                    document.getElementById('error-details').style.display = 'block';
                }
                
                this.showModal('error-modal');
            },

            showModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            },

            showLoading(text = 'Loading...', detail = '') {
                document.getElementById('loading-text').textContent = text;
                document.getElementById('loading-detail').textContent = detail;
                document.getElementById('loading').classList.remove('hidden');
            },

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            },

            retryLastAction() {
                this.closeModal('error-modal');
                if (lastFailedAction) {
                    lastFailedAction();
                }
            },

            // Premium Features
            redirectToPremium() {
                this.showModal('premium-modal');
            },

            redirectToSolpay() {
                window.open('https://solpay.com/premium/grantapp', '_blank');
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GrantApp Adaptive Quiz Engine initialized');
            
            // Set current year in footer if exists
            const yearElement = document.getElementById('current-year');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
            
            // Initialize tooltips
            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            tooltipContainers.forEach(container => {
                container.addEventListener('mouseenter', function() {
                    const tooltip = this.querySelector('.tooltip');
                    if (tooltip) {
                        tooltip.style.opacity = '1';
                    }
                });
                
                container.addEventListener('mouseleave', function() {
                    const tooltip = this.querySelector('.tooltip');
                    if (tooltip) {
                        tooltip.style.opacity = '0';
                    }
                });
            });
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            GrantApp.showError('Unexpected Error', 'An unexpected error occurred. Please refresh the page and try again.', e.error);
        });

        // Export for global access
        window.GrantApp = GrantApp;
    </script>
</body>
</html>
